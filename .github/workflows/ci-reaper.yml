name: REAPER Cross-Platform Tests

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

jobs:
  test-reaper:
    name: REAPER ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.11']
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Mark workspace as safe git directory (best-effort)
        shell: bash
        run: |
          set -euo pipefail
          if command -v git >/dev/null 2>&1; then
            # Some runners/shells can miss HOME; git config --global then exits 128.
            export HOME="${HOME:-$RUNNER_TEMP}"
            git config --global --add safe.directory "$GITHUB_WORKSPACE" || true
          fi
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install numpy soundfile pytest
      
      - name: Generate test assets
        run: python tests/reaper/generate_test_audio.py
      
      - name: Validate test infrastructure
        run: |
          echo "Validating test infrastructure (REAPER not available on CI runners)..."
          python -c "import json; scenarios=json.load(open('tests/reaper/test_scenarios.json')); print(f'Loaded {len(scenarios[\"scenarios\"])} test scenarios'); print('Quick tests:', scenarios['quick_smoke_tests'])"
          python tests/reaper/generate_rpp.py tests/reaper/test.rpp tests/reaper/assets/test_mix_10s.wav --time-selection 2.0 6.0
          echo "Test infrastructure validated successfully"
      
      - name: Upload test assets
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-assets-${{ matrix.os }}
          path: |
            tests/reaper/assets/
            tests/reaper/test.rpp
