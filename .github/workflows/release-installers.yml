name: Build installers

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to upload assets to (e.g. v2.1.0). Leave empty when running from a tag push."
        required: false
        default: ""
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  STEMWERK_VERSION_FILE: VERSION

jobs:
  validate-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.v.outputs.version }}
      release_tag: ${{ steps.v.outputs.release_tag }}
    steps:
      - uses: actions/checkout@v4

      - id: v
        name: Validate tag matches VERSION
        shell: bash
        run: |
          set -euo pipefail
          VERSION="$(tr -d '\r\n' < "${STEMWERK_VERSION_FILE}")"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

          # Determine release tag:
          # - Tag push: use the pushed tag
          # - workflow_dispatch: use the provided input
          RELEASE_TAG="${{ github.event.inputs.tag }}"
          if [[ -z "$RELEASE_TAG" && "${GITHUB_REF_TYPE:-}" == "tag" ]]; then
            RELEASE_TAG="${GITHUB_REF_NAME}"
          fi

          # Nice UX: when manually running workflow_dispatch, default to v<VERSION>
          if [[ -z "$RELEASE_TAG" ]]; then
            RELEASE_TAG="v$VERSION"
          fi

          # Accept '2.1.1' and normalize to 'v2.1.1'
          if [[ "$RELEASE_TAG" != v* ]]; then
            RELEASE_TAG="v$RELEASE_TAG"
          fi

          echo "release_tag=$RELEASE_TAG" >> "$GITHUB_OUTPUT"

          TAG_VER="${RELEASE_TAG#v}"
          if [[ "$TAG_VER" != "$VERSION" ]]; then
            echo "ERROR: release tag $RELEASE_TAG does not match VERSION=$VERSION"
            exit 1
          fi

  windows-exe:
    needs: validate-version
    runs-on: windows-latest
    env:
      STEMWERK_VERSION: ${{ needs.validate-version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Inno Setup
        shell: powershell
        run: |
          choco install innosetup --no-progress -y

      - name: Build .exe (Inno Setup)
        shell: powershell
        run: |
          $iscc = "${env:ProgramFiles(x86)}\Inno Setup 6\ISCC.exe"
          if (!(Test-Path $iscc)) { throw "ISCC.exe not found at $iscc" }
          & $iscc "installer\windows\STEMwerk.iss"

      - name: Upload release asset (Windows .exe)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.validate-version.outputs.release_tag }}
          files: installer/windows/dist/*.exe

  macos-pkg:
    needs: validate-version
    runs-on: macos-latest
    env:
      STEMWERK_VERSION: ${{ needs.validate-version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Build .pkg
        shell: bash
        run: |
          bash installer/macos/build_pkg.sh

      - name: Upload release asset (macOS .pkg)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.validate-version.outputs.release_tag }}
          files: installer/macos/dist/*.pkg

  linux-packages:
    needs: validate-version
    runs-on: ubuntu-latest
    env:
      STEMWERK_VERSION: ${{ needs.validate-version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Install build deps
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            rsync dpkg-dev rpm curl

      - name: Build .deb
        shell: bash
        run: |
          bash installer/linux/build_deb.sh

      - name: Build .rpm
        shell: bash
        run: |
          bash installer/linux/build_rpm.sh

      - name: Build AppImage
        shell: bash
        run: |
          bash installer/linux/build_appimage.sh

      - name: Upload release assets (Linux)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.validate-version.outputs.release_tag }}
          files: |
            installer/linux/dist/*.deb
            installer/linux/dist/*.rpm
            installer/linux/dist/*.AppImage


